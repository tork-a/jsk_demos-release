#!/usr/bin/env roseus

(ros::load-ros-manifest "roseus")
(ros::load-ros-manifest "jsk_ipad_gui")
(ros::roseus "demo_webui")

(load "package://pr2eus/pr2-interface.l")
(load "package://jsk_2011_07_pr2_semantic/euslisp/knowrob-interface.l")
(load "package://jsk_2011_07_pr2_semantic/euslisp/main.l")

(defun init-settings ()
  (pr2)
  (setq *ri* (instance pr2-interface :init))
  (setq *time-count* (ros::time-now))
  (setq *jp* (instance json_prolog :init "json_prolog"))
  (ros::ros-info "init-settings end")
  )

(defun str-srv (req)
  (let ((m (send req :response)))
    (ros::ros-info "str-srv:~A" (send req :str))
    (insert-robot-pose)
    (print (send req :str))
;;    (send m :str (format nil "~A" (find-knowrob-objects-with-info (send req :str))))
    (send m :str (format nil "~A" (similar-objects-with-info-by-distance (send req :str))))
    m))

(defun str-cb (msg)
  (cond ((> 0 (send (ros::time- (send msg :header :stamp) *time-count*) :to-sec))
	 (return-from str-cb nil))
	((not (equal (read-from-string (send msg :header :frame_id)) 'knowrob))
	 (return-from str-cb nil)))
  (ros::ros-info "Got ~A" (send msg :selection))
  (let* ((name (send msg :selection))
	 (infront-of "'http://ias.cs.tum.edu/kb/knowrob.owl#inFrontOf-Generally'")
	 (obj (format nil "http://www.jsk.t.u-tokyo.ac.jp/jsk_map.owl#cup-~A" name)) solutions robot-pose opose)
    (print obj)
    (setq solutions
	  (send *jp* :query
		(list->prolog
		 (list (format nil "OBJ='~a'" obj)
		       `(owl_has :spot ,infront-of :obj))) :pose '("OBJ" "SPOT")))
    (setq solutions (list (elt solutions 0)))
    (setq obj (cadr (assoc "OBJ" (car solutions) :test #'string=)))
    (setq robot-pose (cadr (assoc "POSE_SPOT" (car solutions) :test #'equal)))
    (setq obj-pose (cadr (assoc "POSE_OBJ" (car solutions) :test #'equal)))

    (setq opose (send *tfl* :lookup-transform "/map" "/base_footprint" (ros::time 0)))
    (ros::spin-once)

    (pr2-tuckarm-pose :larm)
    (clear-costmap)
    (send *ri* :wait-interpolation)
    (ros::ros-info "GO to ~A" robot-pose)
    (send *ri* :move-to robot-pose)
    (ros::spin-once)
    (send *pr2* :move-to (send *tfl* :lookup-transform "/map" "/base_footprint" (ros::time 0)) :world)
    (send *pr2* :head :look-at (send obj-pose :worldpos))
    (send *ri* :angle-vector (send *pr2* :angle-vector) 2000)
    (send *ri* :wait-interpolation)
    ;; grasp cup here
    (speak-jp "こっぷをさがしています")
    (let ((neck-av (send *pr2* :head :angle-vector)))
      (setq flag
	    (or (check :timeout 10 :type name)
		(progn (send *pr2* :head :angle-vector (v+ #f(20 0) neck-av))
		       (send *ri* :angle-vector (send *pr2* :angle-vector) 500)
		       (send *ri* :wait-interpolation)
		       (check :timeout 10 :type name))
		(progn (send *pr2* :head :angle-vector (v+ #f(-20 0) neck-av))
		       (send *ri* :angle-vector (send *pr2* :angle-vector) 500)
		       (send *ri* :wait-interpolation)
		       (check :timeout 10 :type name)))
	    ))
    (when flag
      (speak-jp "こっぷがみつかりました")
      (pick :larm)
      (send *pr2* :angle-vector (send *ri* :state :potentio-vector))
      (send *pr2* :head :angle-vector #f(0 0))
      (send *pr2* :torso :angle-vector #f(0))
      (send *ri* :angle-vector (send *pr2* :angle-vector) 2000)
      (send *ri* :wait-interpolation)
      (clear-costmap)
      (send *ri* :move-to opose)
      (speak-jp "こっぷをもってきました")
      (hand-over :larm)
      (return))
    (speak-jp "こっぷはみつかりませんでした")
    (pr2-tuckarm-pose :larm)
    ))

;;
(init-settings)
(ros::advertise-service "/ipad/service/knowrob" roseus::StringString #'str-srv)
(ros::subscribe "/ipad/event/select" jsk_ipad_gui::iPadSelect #'str-cb)

(ros::rate 10)
(do-until-key
 (ros::sleep)
 (ros::spin-once))

;;(find-knowrob-objects "Cup")